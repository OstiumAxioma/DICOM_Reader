# CT图像绘制缩放系统

## 项目概述
基于Qt的CT图像处理系统，支持三正交视图显示
主要功能：缩放、平移、窗宽窗位调节

## 系统架构

### 1. 核心组件
- **CT数据结构**：基于DICOM格式，包含width、height、total层数
- **绘制区域**：固定的m_glRect区域
- **3D坐标系**：支持空间坐标与屏幕坐标转换（curcenter）

### 2. 关键变量
- `m_scale`：缩放倍数，<1表示缩小，>1表示放大
- `viewRect`：视图偏移，由ImgVmFactory管理，用于平移操作
- `img_width/img_height`：缩放后的图像尺寸
- `m_imgRct`：图像绘制矩形，通常与m_glRect相同
- `m_curQImg`：当前的QImage对象
- `iterx/itery`：迭代坐标，用于数据遍历
- `curcenter`：空间坐标系中的3D中心点

### 3. 缩放机制
**单位视图计算**：基于物理尺寸
1. 根据m_scale计算unitView（img_width/img_height）
2. 将CT数据转换为QImage（m_curQImg）
3. 使用drawImage绘制到指定区域（m_imgRct）

### 4. CT数据处理
基于CT图像的spacing和实际尺寸：
- `ct_width/ct_height`：CT图像物理尺寸
- 根据视图类型进行数据索引：
  - 轴位（AXIAL）：标准横断面，Z轴索引
  - 冠状位（CORONAL）：前后断面，Y轴索引

## 坐标转换

### 空间到屏幕
1. 缩放计算：基于`viewRect.x(), viewRect.y()`偏移
2. 应用单位视图比例进行坐标映射
3. 最终转换到屏幕像素坐标

### 绘制系统（QPainter相关）
- 使用空间坐标系进行逻辑计算
- 通过`pointFromSpaceToGl`进行坐标转换

## 缩放中心问题的正确理解

### 用户期望的缩放行为
1. **缩放中心**: 始终以视图中心为基准，而不是viewRect中心
2. **支持平移后缩放**: 用户可能已经平移了图像（viewRect ≠ (0,0)）
3. **解剖位置保持**: 当前视图中心指向的图像解剖位置应该保持在视图中心
4. **围绕中心缩放**: 图像应该围绕该解剖位置放大/缩小，而不是向左上角偏移

### 技术实现要点
- 缩放中心 = 视图中心指向的图像位置
- 需要在scale()函数中调整viewRect位置
- 计算公式涉及m_unitView、viewRect坐标、视图尺寸的关系
- 保持解剖位置在视图中心不变

### 当前问题
所有视图（轴位、冠状位、矢状位）在放大时都向左上角偏移，没有实现真正的中心缩放

## 注意事项
- viewRect负责平移功能的实现
- m_imgRct负责图像绘制区域的定义
- 坐标转换时需要考虑物理尺寸
- 需要处理空间坐标与屏幕坐标的映射关系

## 项目记忆信息

### 基本信息
- **项目路径**: `D:\Project\Aimbrain-1.0\AimooePre`
- **开发环境**: Windows + Qt/C++
- **当前分支**: main
- **核心文件**: GlWdgImpl.cpp (paintEvent函数)

### 已知缩放问题
根据git提交历史：
- d8728e0: 缩小不会往左上角，但是放大会了
- e7374b8: 还没有排除宽度触碰窗口边界后往左上角缩放的问题

### 技术特点
- 支持DICOM CT数据加载
- 三正交视图显示（轴位、冠状位、矢状位）
- 实时缩放、平移、窗宽窗位调节
- 支持标注绘制（点、线、多边形、曲线）
- 空间坐标与屏幕坐标双向转换

### paintEvent函数分析要点
- **函数位置**: GlWdgImpl.cpp:595-959
- **核心功能**: CT数据渲染、缩放计算、坐标转换
- **缩放逻辑**: 基于m_scale和unitView的双重计算
- **数据索引**: 支持三视图的不同数据访问模式
- **窗宽窗位**: 支持HU值范围和标准窗宽窗位两种模式